# (최초 1회) 저장소 갱신
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
helm repo update

# 원하는 차트 버전 확인
helm search repo rancher-stable/rancher --versions

helm show values rancher-stable/rancher --version 2.11.2 > values.yaml

kubectl create namespace cattle-system

# 설치 또는 업그레이드
helm upgrade --install rancher rancher-stable/rancher \
  -n cattle-system \
  --version 2.11.2 \
  -f values.yaml -f rancher.yaml
# 삭제
helm delete rancher -n cattle-system

# cert-manager 설치(이걸 먼저 설치해야 랜처 설치 오류가 안난다.)
helm repo add jetstack https://charts.jetstack.io
helm repo update
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager --create-namespace \
  --set crds.enabled=true
kubectl get pods -n cert-manager
kubectl get crd | grep cert-manager.io
# issuers.cert-manager.io, clusterissuers.cert-manager.io 등이 보여야 합니다.


# 시크릿 tls
# 호스트 설정
HOST=rancher.192.168.64.2.sslip.io
# 자체 서명 인증서 생성
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt \
  -subj "/CN=$HOST/O=$HOST" \
  -addext "subjectAltName = DNS:$HOST"

# cattle-system에 TLS 시크릿 생성
kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=tls.crt --key=tls.key